 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/main_window.py b/main_window.py
index c2438d1eb5929887d8ee69ce37e0acb334a71f5e..00201b7a622ebbca5dc8f43627e4ca053ba7ac8d 100644
--- a/main_window.py
+++ b/main_window.py
@@ -3440,50 +3440,51 @@ class MainWindow(QMainWindow):
             entry = grouped.get(order_id)
             if not entry:
                 entry = {
                     "order_id": order_id,
                     "date": record.get("date", ""),
                     "order_date_raw": record.get("order_date_raw"),
                     "sample_date_raw": record.get("sample_date_raw"),
                     "patient": record.get("patient", ""),
                     "document": record.get("document", ""),
                     "doc_type": record.get("doc_type"),
                     "doc_number": record.get("doc_number"),
                     "birth_date": record.get("birth_date"),
                     "hcl": record.get("hcl"),
                     "height": record.get("height"),
                     "weight": record.get("weight"),
                     "blood_pressure": record.get("blood_pressure"),
                     "sex": record.get("sex"),
                     "origin": record.get("origin"),
                     "is_pregnant": record.get("is_pregnant"),
                     "gestational_age_weeks": record.get("gestational_age_weeks"),
                     "expected_delivery_date": record.get("expected_delivery_date"),
                     "age": record.get("age", ""),
                     "first_name": record.get("first_name"),
                     "last_name": record.get("last_name"),
                     "observations": record.get("order_observations"),
+                    "requested_by": record.get("requested_by"),
                     "insurance_type": record.get("insurance_type"),
                     "fua_number": record.get("fua_number"),
                     "emitted": record.get("emitted"),
                     "emitted_at": record.get("emitted_at"),
                     "groups": {key: [] for key in group_keys},
                     "tests": [],
                     "sample_statuses": [],
                     "pending_tests": [],
                     "test_detail_map": OrderedDict()
                 }
                 grouped[order_id] = entry
             group_key = self._map_category_group(record.get("category"))
             if has_result:
                 for item in summary_items:
                     cleaned = str(item).strip()
                     if cleaned:
                         entry["groups"].setdefault(group_key, []).append(cleaned)
             test_name = record.get("test")
             if test_name:
                 test_clean = str(test_name).strip()
                 if test_clean and test_clean not in entry.setdefault("tests", []):
                     entry["tests"].append(test_clean)
                 detail_map = entry.setdefault("test_detail_map", OrderedDict())
                 detail_entry = detail_map.get(test_clean, {
                     "test": test_clean,
@@ -5006,131 +5007,134 @@ class MainWindow(QMainWindow):
         self.history_fua_btn = QToolButton()
         self.history_fua_btn.setToolTip("Registrar FUA")
         self.history_fua_btn.setIcon(self.style().standardIcon(QStyle.SP_FileDialogNewFolder))
         self.history_fua_btn.setEnabled(False)
         self.history_window_btn = QToolButton()
         self.history_window_btn.setToolTip("Ventana de historial")
         self.history_window_btn.setIcon(self.style().standardIcon(QStyle.SP_TitleBarMaxButton))
         self.history_window_btn.setEnabled(False)
         for btn in (self.history_open_btn, self.history_fua_btn, self.history_window_btn):
             btn.setToolButtonStyle(Qt.ToolButtonIconOnly)
         history_toolbar_layout.addWidget(self.history_open_btn)
         history_toolbar_layout.addWidget(self.history_fua_btn)
         history_toolbar_layout.addWidget(self.history_window_btn)
         history_toolbar_layout.addStretch()
         history_tab_layout.addLayout(history_toolbar_layout)
 
         self.history_tab = history_tab
         history_workspace = QWidget()
         self.history_workspace = history_workspace
         self.history_workspace_layout = QGridLayout(history_workspace)
         self.history_workspace_layout.setContentsMargins(0, 0, 0, 0)
         self.history_workspace_layout.setSpacing(8)
 
         self.history_orders_panel = QGroupBox("Historial de órdenes")
         orders_layout = QVBoxLayout(self.history_orders_panel)
-        orders_layout.setSpacing(6)
+        orders_layout.setSpacing(4)
         history_search_layout = QHBoxLayout()
         history_search_layout.addWidget(QLabel("DNI:"))
         self.history_doc_input = QLineEdit()
         self.history_doc_input.setPlaceholderText("Ingrese DNI")
         history_search_layout.addWidget(self.history_doc_input)
         history_search_layout.addWidget(QLabel("Apellidos:"))
         self.history_lastname_input = QLineEdit()
         self.history_lastname_input.setPlaceholderText("Ej. PEREZ / PEREZ GARCIA")
         history_search_layout.addWidget(self.history_lastname_input)
         self.history_search_btn = QToolButton()
         self.history_search_btn.setToolTip("Buscar")
         self.history_search_btn.setIcon(self.style().standardIcon(QStyle.SP_FileDialogContentsView))
         history_search_layout.addWidget(self.history_search_btn)
         history_search_layout.addStretch()
         orders_layout.addLayout(history_search_layout)
         history_headers = [
             "F. muestra / Registro",
             "Orden",
             "Paciente",
             "Documento",
             "F. Nacimiento",
             "Edad",
             "Gestación",
             "Sexo",
             "Procedencia",
             "HCL",
             "Tipo de seguro",
             "FUA",
             "Seguimiento",
             "Exámenes de la orden",
             "Hematología",
             "Bioquímica",
             "Micro/Parasitología",
             "Otros exámenes",
             "Emitido"
         ]
         self.history_table = QTableWidget(0, len(history_headers))
         self.history_table.setHorizontalHeaderLabels(history_headers)
         self.history_table.setSelectionBehavior(QTableWidget.SelectRows)
         self.history_table.setSelectionMode(QTableWidget.SingleSelection)
         self.history_table.setAlternatingRowColors(True)
         self.history_table.setWordWrap(True)
         self.history_table.verticalHeader().setVisible(False)
         self.history_table.horizontalHeader().setStretchLastSection(True)
         self.history_table.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
         self.history_headers = history_headers
         self.history_column_map = {header: idx for idx, header in enumerate(history_headers)}
         orders_layout.addWidget(self.history_table)
 
-        self.history_patient_panel = QGroupBox("Resumen del paciente")
+        self.history_patient_panel = QGroupBox("Resumen clínico del paciente")
         patient_layout = QVBoxLayout(self.history_patient_panel)
         self.history_patient_summary_label = QLabel()
         self.history_patient_summary_label.setWordWrap(True)
         self.history_patient_summary_label.setTextFormat(Qt.RichText)
-        self.history_patient_summary_label.setStyleSheet("QLabel { padding: 6px; }")
+        self.history_patient_summary_label.setStyleSheet("QLabel { padding: 4px; }")
         patient_scroll = QScrollArea()
         patient_scroll.setWidgetResizable(True)
         patient_scroll.setFrameShape(QFrame.NoFrame)
         patient_container = QWidget()
         patient_container_layout = QVBoxLayout(patient_container)
         patient_container_layout.setContentsMargins(0, 0, 0, 0)
         patient_container_layout.addWidget(self.history_patient_summary_label)
         patient_scroll.setWidget(patient_container)
         patient_layout.addWidget(patient_scroll)
 
         self.history_alerts_panel = QGroupBox("Alertas clínicas")
         alerts_layout = QVBoxLayout(self.history_alerts_panel)
+        alerts_layout.setContentsMargins(6, 6, 6, 6)
+        alerts_layout.setSpacing(4)
         self.history_alerts_placeholder = QLabel("Sin alertas registradas.")
         self.history_alerts_placeholder.setStyleSheet("color: #666; padding: 6px;")
         self.history_alerts_container = QWidget()
         self.history_alerts_grid = QGridLayout(self.history_alerts_container)
         self.history_alerts_grid.setContentsMargins(6, 6, 6, 6)
         self.history_alerts_grid.setHorizontalSpacing(6)
         self.history_alerts_grid.setVerticalSpacing(6)
         alerts_scroll = QScrollArea()
         alerts_scroll.setWidgetResizable(True)
         alerts_scroll.setFrameShape(QFrame.NoFrame)
         alerts_scroll.setWidget(self.history_alerts_container)
         alerts_layout.addWidget(self.history_alerts_placeholder)
         alerts_layout.addWidget(alerts_scroll)
+        self.history_has_alerts = False
 
         self.history_detail_panel = QGroupBox("Detalle de la orden / Exámenes")
         detail_layout = QVBoxLayout(self.history_detail_panel)
         detail_toolbar = QHBoxLayout()
         detail_toolbar.addWidget(QLabel("Filtros:"))
         self.history_detail_filter_group = QButtonGroup(self)
         self.history_detail_filter_group.setExclusive(True)
         self.history_filter_done_btn = QToolButton()
         self.history_filter_done_btn.setText("Todos realizados")
         self.history_filter_done_btn.setCheckable(True)
         self.history_filter_done_btn.setChecked(True)
         self.history_filter_pending_btn = QToolButton()
         self.history_filter_pending_btn.setText("Pendientes con muestra")
         self.history_filter_pending_btn.setCheckable(True)
         self.history_filter_critical_btn = QToolButton()
         self.history_filter_critical_btn.setText("Críticos")
         self.history_filter_critical_btn.setCheckable(True)
         for btn in (self.history_filter_done_btn, self.history_filter_pending_btn, self.history_filter_critical_btn):
             btn.setToolButtonStyle(Qt.ToolButtonTextOnly)
             self.history_detail_filter_group.addButton(btn)
             detail_toolbar.addWidget(btn)
         detail_toolbar.addStretch()
         detail_layout.addLayout(detail_toolbar)
         self.history_detail_empty = QLabel("Sin exámenes realizados/recibidos en esta orden.")
         self.history_detail_empty.setAlignment(Qt.AlignCenter)
@@ -5986,240 +5990,337 @@ class MainWindow(QMainWindow):
         pdf.set_auto_page_break(prev_auto, margin=prev_bottom)
 
     def _clear_history_table(self):
         if hasattr(self, 'history_table'):
             self.history_table.setRowCount(0)
         self._history_results = []
         if hasattr(self, 'history_open_btn'):
             self.history_open_btn.setEnabled(False)
         if hasattr(self, 'history_window_btn'):
             self.history_window_btn.setEnabled(False)
         self._render_history_preview(None)
 
     def _clear_layout(self, layout):
         if not layout:
             return
         while layout.count():
             item = layout.takeAt(0)
             widget = item.widget()
             if widget:
                 widget.setParent(None)
 
     def _update_history_workspace_layout(self):
         if not hasattr(self, 'history_tab') or not hasattr(self, 'history_workspace_layout'):
             return
         width = self.history_tab.width()
+        has_alerts = bool(getattr(self, 'history_has_alerts', False))
         if width < 980:
             self.history_workspace.hide()
             self.history_mobile_toolbox.show()
             self._clear_layout(self.history_workspace_layout)
             while self.history_mobile_toolbox.count() > 0:
                 widget = self.history_mobile_toolbox.widget(0)
                 self.history_mobile_toolbox.removeItem(0)
                 if widget:
                     widget.setParent(None)
             self.history_mobile_toolbox.addItem(self.history_orders_panel, "Historial")
             self.history_mobile_toolbox.addItem(self.history_patient_panel, "Paciente")
-            self.history_mobile_toolbox.addItem(self.history_alerts_panel, "Alertas")
+            if has_alerts:
+                self.history_mobile_toolbox.addItem(self.history_alerts_panel, "Alertas")
             self.history_mobile_toolbox.addItem(self.history_detail_panel, "Detalle de orden")
             return
         self.history_mobile_toolbox.hide()
         self.history_workspace.show()
         while self.history_mobile_toolbox.count() > 0:
             widget = self.history_mobile_toolbox.widget(0)
             self.history_mobile_toolbox.removeItem(0)
             if widget:
                 widget.setParent(None)
         self._clear_layout(self.history_workspace_layout)
-        column_count = 4 if width >= 1400 else 3
+        show_alerts_column = width >= 1400 and has_alerts
+        column_count = 4 if show_alerts_column else 3
         if column_count == 4:
             self.history_workspace_layout.addWidget(self.history_orders_panel, 0, 0)
             self.history_workspace_layout.addWidget(self.history_patient_panel, 0, 1)
             self.history_workspace_layout.addWidget(self.history_alerts_panel, 0, 2)
             self.history_workspace_layout.addWidget(self.history_detail_panel, 0, 3)
             self.history_workspace_layout.setColumnStretch(0, 4)
-            self.history_workspace_layout.setColumnStretch(1, 3)
-            self.history_workspace_layout.setColumnStretch(2, 3)
-            self.history_workspace_layout.setColumnStretch(3, 4)
+            self.history_workspace_layout.setColumnStretch(1, 4)
+            self.history_workspace_layout.setColumnStretch(2, 2)
+            self.history_workspace_layout.setColumnStretch(3, 5)
         else:
             self._clear_layout(self.history_combined_layout)
-            self.history_combined_layout.addWidget(self.history_alerts_panel)
+            if has_alerts:
+                self.history_combined_layout.addWidget(self.history_alerts_panel)
             self.history_combined_layout.addWidget(self.history_detail_panel)
             self.history_workspace_layout.addWidget(self.history_orders_panel, 0, 0)
             self.history_workspace_layout.addWidget(self.history_patient_panel, 0, 1)
             self.history_workspace_layout.addWidget(self.history_combined_panel, 0, 2)
             self.history_workspace_layout.setColumnStretch(0, 4)
-            self.history_workspace_layout.setColumnStretch(1, 3)
-            self.history_workspace_layout.setColumnStretch(2, 4)
+            self.history_workspace_layout.setColumnStretch(1, 4)
+            self.history_workspace_layout.setColumnStretch(2, 5)
         self.history_workspace_layout.setRowStretch(0, 1)
 
     def _get_selected_history_entry(self):
         if not hasattr(self, 'history_table'):
             return None
         selection = self.history_table.selectionModel()
         if not selection or not selection.selectedRows():
             return None
         row = selection.selectedRows()[0].row()
         history_items = getattr(self, '_history_results', [])
         return history_items[row] if 0 <= row < len(history_items) else None
 
     def _render_history_preview(self, entry):
         if not hasattr(self, 'history_patient_summary_label'):
             return
         if not entry:
             self.history_patient_summary_label.setText(
                 "<p style='color:#666;'>Seleccione una orden para ver los datos del paciente.</p>"
             )
             self._render_history_alerts([])
             self._render_history_detail([])
             return
         self._render_history_patient_summary(entry)
         self._render_history_alerts(self._extract_history_alert_tags(entry))
         self._render_history_detail(entry)
 
     def _render_history_patient_summary(self, entry):
-        def esc(value, fallback="—"):
-            if value in (None, ""):
-                return fallback
+        def esc(value):
             return html.escape(str(value))
 
+        def normalize(value):
+            if value in (None, "", "-", "—"):
+                return None
+            text = str(value).strip()
+            return text if text else None
+
         def to_title(text):
             return text.title() if text else ""
 
+        def format_time(value):
+            if value in (None, ""):
+                return None
+            if isinstance(value, datetime.datetime):
+                return value.strftime("%H:%M")
+            for fmt in ("%Y-%m-%d %H:%M:%S", "%Y-%m-%dT%H:%M:%S", "%Y-%m-%dT%H:%M:%S.%f"):
+                try:
+                    parsed = datetime.datetime.strptime(str(value), fmt)
+                    return parsed.strftime("%H:%M")
+                except (ValueError, TypeError):
+                    continue
+            try:
+                parsed = datetime.datetime.fromisoformat(str(value))
+                return parsed.strftime("%H:%M")
+            except Exception:
+                return None
+
+        def add_row(rows, label, value):
+            if value is None:
+                return
+            rows.append(
+                f"<tr><td style='padding:2px 6px; color:#444; width:38%;'><strong>{esc(label)}</strong></td>"
+                f"<td style='padding:2px 6px;'>{esc(value)}</td></tr>"
+            )
+
+        def section_block(title, rows):
+            if not rows:
+                return ""
+            return (
+                f"<div style='margin-top:6px; font-weight:700; color:#1f4e79; font-size:9.7pt;'>"
+                f"{esc(title)}</div>"
+                "<table style='width:100%; border-collapse:collapse; font-size:9.7pt; margin-top:2px;'>"
+                f"{''.join(rows)}</table>"
+            )
+
         first = to_title(" ".join(str(entry.get("first_name") or "").split()))
         last = to_title(" ".join(str(entry.get("last_name") or "").split()))
         if last and first:
             patient_name = f"{last}, {first}"
         elif last:
             patient_name = last
         elif first:
             patient_name = first
         else:
-            patient_name = to_title(" ".join(str(entry.get("patient") or "").split())) or "—"
+            patient_name = to_title(" ".join(str(entry.get("patient") or "").split()))
+
+        doc_type_value = entry.get("doc_type") or "DNI"
+        doc_label = doc_type_value.upper() if doc_type_value else "DNI"
+        doc_number = normalize(entry.get("doc_number"))
+        age_display = normalize(entry.get("age"))
+        sex_display = normalize(self._format_sex_display(entry.get("sex")))
+        origin_display = normalize(entry.get("origin"))
+        hcl_display = normalize(entry.get("hcl"))
+        insurance_text = normalize(self._format_insurance_display(entry.get("insurance_type")))
+        birth_display = normalize(self._format_short_date(entry.get("birth_date")))
+
+        height_raw = normalize(entry.get("height"))
+        weight_raw = normalize(entry.get("weight"))
+        bp_raw = normalize(entry.get("blood_pressure"))
+        height_num = self._extract_numeric_value(height_raw) if height_raw else None
+        weight_num = self._extract_numeric_value(weight_raw) if weight_raw else None
+        bmi_display = None
+        if height_num and weight_num:
+            height_m = height_num / 100 if height_num > 10 else height_num
+            if height_m > 0:
+                bmi_display = self._format_decimal(weight_num / (height_m ** 2), 1)
+        if height_raw and height_num and not re.search(r'[a-zA-Z]', height_raw):
+            height_raw = f"{self._format_decimal(height_num, 1)} cm"
+        if weight_raw and weight_num and not re.search(r'[a-zA-Z]', weight_raw):
+            weight_raw = f"{self._format_decimal(weight_num, 1)} kg"
+        if bp_raw and isinstance(bp_raw, str):
+            bp_raw = bp_raw.replace("  ", " ").strip()
+
+        order_date_raw = entry.get("order_date_raw")
+        order_date = normalize(self._format_date_display(order_date_raw, ""))
+        order_time = normalize(format_time(order_date_raw))
+        emitted_time = normalize(format_time(entry.get("emitted_at")))
+        requested_by = normalize(entry.get("requested_by"))
+
+        personal_rows = []
+        add_row(personal_rows, "Nombre completo", normalize(patient_name))
+        add_row(personal_rows, doc_label, doc_number)
+        add_row(personal_rows, "Edad", age_display)
+        add_row(personal_rows, "Sexo", sex_display)
+        add_row(personal_rows, "Procedencia", origin_display)
+        add_row(personal_rows, "HCL", hcl_display)
+        add_row(personal_rows, "Seguro", insurance_text)
+        add_row(personal_rows, "F. Nac.", birth_display)
+
+        vitals_rows = []
+        add_row(vitals_rows, "Talla", height_raw)
+        add_row(vitals_rows, "Peso", weight_raw)
+        add_row(vitals_rows, "Presión arterial", bp_raw)
+        add_row(vitals_rows, "IMC", bmi_display)
+
+        order_rows = []
+        add_row(order_rows, "Médico solicitante", requested_by)
+        add_row(order_rows, "Fecha de orden", order_date)
+        add_row(order_rows, "Hora de registro", order_time)
+        add_row(order_rows, "Hora de emisión/validación", emitted_time)
 
-        doc_type_value = entry.get("doc_type")
-        doc_label = doc_type_value.upper() if doc_type_value else "Doc."
-        doc_number = entry.get("doc_number") or "—"
-        age_display = entry.get("age") or "—"
-        sex_display = self._format_sex_display(entry.get("sex"))
-        origin_display = entry.get("origin") or "—"
-        hcl_display = entry.get("hcl") or "—"
-        insurance_text = self._format_insurance_display(entry.get("insurance_type"))
-        fua_text = self._format_fua_display(entry)
-        birth_display = self._format_short_date(entry.get("birth_date"))
         header_date = self._format_date_for_registry(entry)
-        emitted_text = self._format_emission_status(entry.get("emitted"), entry.get("emitted_at"))
-        pregnancy_line = self._format_registry_pregnancy_line(entry)
-        pregnancy_display = pregnancy_line.replace("Gestante:", "Gestación:") if pregnancy_line else "Gestación: No"
+        order_id = normalize(entry.get("order_id"))
+        header_parts = [part for part in [f"Orden #{order_id}" if order_id else None, header_date] if part]
+        header_text = " · ".join(header_parts) if header_parts else "Resumen clínico"
 
         html_output = f"""
-        <div style="font-weight:700; font-size:12pt;">Orden #{esc(entry.get("order_id", "-"))} · {esc(header_date or "-")}</div>
-        <div style="color:#555; font-size:10pt; margin-bottom:6px;">
-            Seguro: <strong>{esc(insurance_text)}</strong> · FUA: <strong>{esc(fua_text)}</strong> · Emitido: <strong>{esc(emitted_text)}</strong>
-        </div>
-        <table style="width:100%; border-collapse:collapse; font-size:10.5pt;">
-            <tr><td style="padding:3px 6px;"><strong>Paciente</strong></td><td style="padding:3px 6px;">{esc(patient_name)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>{esc(doc_label)}</strong></td><td style="padding:3px 6px;">{esc(doc_number)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>F. Nac.</strong></td><td style="padding:3px 6px;">{esc(birth_display)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>Edad</strong></td><td style="padding:3px 6px;">{esc(age_display)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>Sexo</strong></td><td style="padding:3px 6px;">{esc(sex_display)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>Procedencia</strong></td><td style="padding:3px 6px;">{esc(origin_display)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>HCL</strong></td><td style="padding:3px 6px;">{esc(hcl_display)}</td></tr>
-            <tr><td style="padding:3px 6px;"><strong>Gestación</strong></td><td style="padding:3px 6px;">{esc(pregnancy_display.replace("Gestación:", "").strip())}</td></tr>
-        </table>
+        <div style="font-weight:700; font-size:11.2pt; margin-bottom:4px;">{esc(header_text)}</div>
+        {section_block("Datos personales", personal_rows)}
+        {section_block("Signos vitales", vitals_rows)}
+        {section_block("Datos de la orden", order_rows)}
         """
         self.history_patient_summary_label.setText(html_output)
 
     def _extract_history_alert_tags(self, entry):
         tags = []
         is_pregnant = self._normalize_bool(entry.get("is_pregnant"))
         if is_pregnant:
-            tags.append("Gestación")
+            tags.append("Embarazo")
         text_bits = []
         observations = entry.get("observations")
         if observations:
             text_bits.append(str(observations))
         for status in entry.get("sample_statuses", []) or []:
             issue = status.get("issue")
             if issue:
                 text_bits.append(str(issue))
         combined = " ".join(text_bits).lower()
         if "alerg" in combined:
             tags.append("Alergias")
         if re.search(r'\b(vih|hiv)\b', combined):
             tags.append("VIH reactivo previo")
         if re.search(r'\b(tb|tbc|tuberc)', combined):
             tags.append("TB previa")
+        if re.search(r'\bcron', combined):
+            tags.append("Dx crónico")
         if re.search(r'\b(dm|diabet)', combined):
             tags.append("DM")
         if "hta" in combined or "hipert" in combined:
             tags.append("HTA")
         if "anticoag" in combined:
-            tags.append("Anticoagulantes")
-        if "crit" in combined:
-            tags.append("Resultado crítico previo")
+            tags.append("Anticoagulación")
+        has_critical = any(detail.get("is_critical") for detail in entry.get("test_details", []) or [])
+        if "crit" in combined or has_critical:
+            tags.append("Resultados críticos recientes")
         if "repetir" in combined:
             tags.append("Repetir muestra")
+        pending_tests = entry.get("pending_tests") or []
+        if pending_tests:
+            tags.append("Exámenes pendientes hoy")
         deduped = []
         for tag in tags:
             if tag not in deduped:
                 deduped.append(tag)
         return deduped
 
     def _render_history_alerts(self, tags):
         if not hasattr(self, 'history_alerts_grid'):
             return
+        prev_state = bool(getattr(self, 'history_has_alerts', False))
         while self.history_alerts_grid.count():
             item = self.history_alerts_grid.takeAt(0)
             widget = item.widget()
             if widget:
                 widget.deleteLater()
-        if not tags:
-            self.history_alerts_placeholder.show()
+        has_alerts = bool(tags)
+        self.history_alerts_placeholder.setVisible(False)
+        if not has_alerts:
+            self.history_has_alerts = False
+            if hasattr(self, 'history_alerts_panel'):
+                self.history_alerts_panel.setVisible(False)
+            if prev_state != has_alerts:
+                self._update_history_workspace_layout()
             return
-        self.history_alerts_placeholder.hide()
+        self.history_has_alerts = True
+        if hasattr(self, 'history_alerts_panel'):
+            self.history_alerts_panel.setVisible(True)
         color_map = {
             "Alergias": ("#ffe7cc", "#8a4b08"),
             "VIH reactivo previo": ("#ffd6d6", "#a12626"),
             "TB previa": ("#ffd6d6", "#a12626"),
-            "Resultado crítico previo": ("#ffd6d6", "#a12626"),
-            "Anticoagulantes": ("#fff1cc", "#7a4d00"),
+            "Resultados críticos recientes": ("#ffd6d6", "#a12626"),
+            "Anticoagulación": ("#fff1cc", "#7a4d00"),
             "HTA": ("#fff1cc", "#7a4d00"),
             "DM": ("#fff1cc", "#7a4d00"),
-            "Gestación": ("#e8e1ff", "#4b2e83"),
+            "Embarazo": ("#e8e1ff", "#4b2e83"),
             "Repetir muestra": ("#ffe7cc", "#8a4b08"),
+            "Dx crónico": ("#e7f3ff", "#1f4e79"),
+            "Exámenes pendientes hoy": ("#ffe7cc", "#8a4b08"),
         }
         for idx, tag in enumerate(tags):
             bg, fg = color_map.get(tag, ("#e7f3ff", "#1f4e79"))
             chip = QLabel(tag)
             chip.setStyleSheet(
-                f"QLabel {{ background-color: {bg}; color: {fg}; border-radius: 8px; padding: 4px 8px; }}"
+                f"QLabel {{ background-color: {bg}; color: {fg}; border-radius: 8px; padding: 3px 8px; }}"
             )
             chip.setSizePolicy(QSizePolicy.Maximum, QSizePolicy.Fixed)
-            row = idx // 2
-            col = idx % 2
+            row = idx
+            col = 0
             self.history_alerts_grid.addWidget(chip, row, col, Qt.AlignLeft)
+        if prev_state != has_alerts:
+            self._update_history_workspace_layout()
 
     def _render_history_detail(self, entry):
         if not hasattr(self, 'history_detail_tree'):
             return
         self.history_detail_tree.clear()
         filter_mode = "done"
         if hasattr(self, 'history_filter_pending_btn') and self.history_filter_pending_btn.isChecked():
             filter_mode = "pending"
         elif hasattr(self, 'history_filter_critical_btn') and self.history_filter_critical_btn.isChecked():
             filter_mode = "critical"
         detail_items = []
         if isinstance(entry, dict):
             detail_items = entry.get("test_details", [])
         if not detail_items:
             self.history_detail_tree.hide()
             self.history_detail_empty.show()
             return
         grouped = OrderedDict()
         group_labels = OrderedDict([
             ("hematology", "Hematología"),
             ("biochemistry", "Bioquímica"),
             ("micro_parasito", "Micro/Parasitología"),
             ("others", "Otros exámenes"),
         ])
         for item in detail_items:
@@ -6335,50 +6436,51 @@ class MainWindow(QMainWindow):
         records = []
         for row in rows:
             (
                 order_id,
                 date_str,
                 sample_date_str,
                 test_name,
                 raw_result,
                 category,
                 first_name,
                 patient_last_name,
                 doc_type,
                 doc_value,
                 sex,
                 birth_date,
                 hcl,
                 origin,
                 height,
                 weight,
                 blood_pressure,
                 is_pregnant,
                 gest_age_weeks,
                 expected_delivery,
                 age_years,
                 order_obs,
+                requested_by,
                 insurance_type,
                 fua_number,
                 emitted,
                 emitted_at,
                 sample_status,
                 sample_issue,
                 observation,
                 pending_since,
                 entry_id
             ) = row
             display_date = self._format_date_display(sample_date_str, "-")
             if display_date == "-":
                 display_date = self._format_datetime_display(date_str, date_str or "-")
             patient_name = " ".join(part for part in [(first_name or "").upper(), (patient_last_name or "").upper()] if part).strip() or "-"
             doc_text = " ".join(part for part in (doc_type, doc_value) if part).strip() or "-"
             age_display = str(age_years) if age_years not in (None, "") else "-"
             context = {
                 "patient": {"sex": sex, "birth_date": birth_date},
                 "order": {"age_years": age_years}
             }
             summary_items = self._build_registry_summary(test_name, raw_result, context=context)
             sample_received = self._is_sample_received_status(sample_status)
             has_result = bool(summary_items)
             if not summary_items and not sample_received:
                 continue
@@ -6392,50 +6494,51 @@ class MainWindow(QMainWindow):
                 "order_date_raw": date_str,
                 "sample_date_raw": sample_date_str,
                 "patient": patient_name,
                 "document": doc_text,
                 "doc_type": doc_type,
                 "doc_number": doc_value,
                 "birth_date": birth_date,
                 "hcl": hcl,
                 "height": height,
                 "weight": weight,
                 "blood_pressure": blood_pressure,
                 "sex": sex,
                 "origin": origin,
                 "is_pregnant": is_pregnant,
                 "gestational_age_weeks": gest_age_weeks,
                 "expected_delivery_date": expected_delivery,
                 "age": age_display,
                 "test": test_name,
                 "result": result_text,
                 "summary_items": summary_items,
                 "has_result": has_result,
                 "sample_received": sample_received,
                 "is_critical": self._detect_critical_result(raw_result, summary_items),
                 "category": category,
                 "order_observations": order_obs,
+                "requested_by": requested_by,
                 "insurance_type": insurance_type,
                 "fua_number": fua_number,
                 "emitted": emitted,
                 "emitted_at": emitted_at,
                 "first_name": first_name,
                 "last_name": patient_last_name,
                 "sample_status": sample_status,
                 "sample_issue": sample_issue,
                 "observation": observation,
                 "pending_since": pending_since
             })
         aggregated = self._aggregate_results_by_order(records)
         self._history_results = aggregated
         self._populate_history_table_widget(self.history_table, aggregated)
         if not aggregated:
             QMessageBox.information(
                 self,
                 "Sin resultados",
                 "No se encontró historial con exámenes realizados o muestras recibidas para los filtros ingresados."
             )
             self._render_history_preview(None)
         else:
             self.history_table.selectRow(0)
         self._on_history_selection_changed()
         if hasattr(self, 'history_window_btn'):
 
EOF
)