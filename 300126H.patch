 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/main_window.py b/main_window.py
index 5f18a06ec3f842c67a0f693dc6c9581f812e5ad9..9ad080ab1f839bddca4ddf6e51f877680c9b44b4 100644
--- a/main_window.py
+++ b/main_window.py
@@ -5522,59 +5522,60 @@ class MainWindow(QMainWindow):
         self.history_alerts_panel = QGroupBox("Alertas clínicas")
         alerts_layout = QVBoxLayout(self.history_alerts_panel)
         alerts_layout.setContentsMargins(6, 6, 6, 6)
         alerts_layout.setSpacing(4)
         self.history_alerts_placeholder = QLabel("Sin alertas registradas.")
         self.history_alerts_placeholder.setStyleSheet("color: #666; padding: 6px;")
         self.history_alerts_container = QWidget()
         self.history_alerts_grid = QGridLayout(self.history_alerts_container)
         self.history_alerts_grid.setContentsMargins(6, 6, 6, 6)
         self.history_alerts_grid.setHorizontalSpacing(6)
         self.history_alerts_grid.setVerticalSpacing(6)
         alerts_scroll = QScrollArea()
         alerts_scroll.setWidgetResizable(True)
         alerts_scroll.setFrameShape(QFrame.NoFrame)
         alerts_scroll.setWidget(self.history_alerts_container)
         alerts_layout.addWidget(self.history_alerts_placeholder)
         alerts_layout.addWidget(alerts_scroll)
         self.history_has_alerts = False
 
         self.history_detail_panel = QGroupBox("Detalle de la orden / Exámenes")
         detail_layout = QVBoxLayout(self.history_detail_panel)
         self.history_detail_empty = QLabel("Sin exámenes registrados en esta orden.")
         self.history_detail_empty.setAlignment(Qt.AlignCenter)
         self.history_detail_empty.setStyleSheet("color: #666; padding: 12px;")
         self.history_detail_tree = QTreeWidget()
-        self.history_detail_tree.setHeaderLabels(["Examen", "Resultado"])
+        self.history_detail_tree.setHeaderLabels(["Examen", "Parámetro", "Resultado"])
         self.history_detail_tree.setRootIsDecorated(False)
         self.history_detail_tree.setAlternatingRowColors(True)
         self.history_detail_tree.setItemsExpandable(True)
         self.history_detail_tree.setUniformRowHeights(False)
         self.history_detail_tree.setTextElideMode(Qt.ElideNone)
         header = self.history_detail_tree.header()
         header.setSectionResizeMode(0, QHeaderView.ResizeToContents)
-        header.setSectionResizeMode(1, QHeaderView.Stretch)
+        header.setSectionResizeMode(1, QHeaderView.ResizeToContents)
+        header.setSectionResizeMode(2, QHeaderView.Stretch)
         self.history_detail_tree.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
         self.history_detail_tree.itemClicked.connect(self._toggle_history_detail_item)
         detail_layout.addWidget(self.history_detail_empty)
         detail_layout.addWidget(self.history_detail_tree)
 
         self.history_combined_panel = QFrame()
         self.history_combined_panel.setFrameShape(QFrame.NoFrame)
         combined_layout = QVBoxLayout(self.history_combined_panel)
         combined_layout.setContentsMargins(0, 0, 0, 0)
         combined_layout.setSpacing(8)
         combined_layout.addWidget(self.history_alerts_panel)
         combined_layout.addWidget(self.history_detail_panel)
         self.history_combined_layout = combined_layout
 
         self.history_mobile_toolbox = QToolBox()
 
         history_tab_layout.addWidget(history_workspace)
         history_tab_layout.addWidget(self.history_mobile_toolbox)
         self.history_mobile_toolbox.hide()
         self.analysis_tabs.addTab(history_tab, "Historial de pacientes")
         self._stats_controls_ready = False
         self.stats_mode_combo.currentIndexChanged.connect(self._update_stats_period_controls)
         self.stats_month_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_quarter_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_year_spin.valueChanged.connect(lambda _: self.refresh_statistics())
@@ -6771,96 +6772,138 @@ class MainWindow(QMainWindow):
             grouped[section_key].append(item)
         any_rows = False
         def build_result_display(detail_item, test_name):
             raw_result = detail_item.get("raw_result")
             observation = detail_item.get("observation")
             issue = detail_item.get("issue")
             if self._is_blank_result(raw_result):
                 fallback_text = (observation or issue or "").strip()
                 return fallback_text if fallback_text else "Resultado no registrado"
             parsed = self._parse_stored_result(raw_result)
             if parsed.get("type") == "structured":
                 lines = self._format_result_lines(test_name, raw_result, context=detail_context)
                 if lines:
                     return " | ".join(lines)
                 structured_text = self._structured_dict_to_text(parsed.get("values", {}))
                 if structured_text:
                     return structured_text
             text_value = parsed.get("value", raw_result or "")
             if isinstance(text_value, str):
                 text_value = text_value.strip()
             if text_value:
                 return str(text_value)
             fallback_text = (observation or issue or "").strip()
             return fallback_text if fallback_text else "Resultado no registrado"
 
+        def build_parameter_rows(detail_item, test_name):
+            raw_result = detail_item.get("raw_result")
+            observation = detail_item.get("observation")
+            issue = detail_item.get("issue")
+            cancel_reason = detail_item.get("cancel_reason")
+            parsed = self._parse_stored_result(raw_result)
+            template = TEST_TEMPLATES.get(test_name)
+            effective_context = detail_context
+            rows = []
+            if parsed.get("type") == "structured" and template:
+                values = parsed.get("values", {})
+                current_section = ""
+                for field_def in template.get("fields", []):
+                    if field_def.get("type") == "section":
+                        current_section = field_def.get("label", "")
+                        continue
+                    key = field_def.get("key")
+                    if not key:
+                        continue
+                    value = values.get(key, "")
+                    if isinstance(value, str):
+                        stripped = value.strip()
+                        if stripped == "":
+                            continue
+                        display_value = " ".join(value.splitlines()).strip()
+                    else:
+                        if self._is_blank_result(value):
+                            continue
+                        display_value = value
+                    unit = field_def.get("unit")
+                    field_type = field_def.get("type")
+                    if unit and field_type not in ("bool", "text_area", "choice"):
+                        display_text = str(display_value)
+                        if not display_text.endswith(unit):
+                            display_value = f"{display_text} {unit}"
+                    reference = self._get_field_reference(field_def, effective_context)
+                    label = field_def.get("label", key)
+                    if current_section:
+                        label = f"{current_section}: {label}"
+                    display_result = f"{display_value}"
+                    if reference:
+                        display_result += f" (Ref: {reference})"
+                    rows.append({"param": label, "result": display_result})
+            if not rows:
+                summary_text = build_result_display(detail_item, test_name)
+                rows.append({"param": "Resultado", "result": summary_text})
+            if issue:
+                rows.append({"param": "Notas", "result": issue})
+            if cancel_reason:
+                rows.append({"param": "Motivo de anulación", "result": cancel_reason})
+            if observation:
+                rows.append({"param": "Observaciones", "result": observation})
+            return rows
+
         for section_key, section_label in sections.items():
             items = grouped.get(section_key, [])
             if not items:
                 continue
             any_rows = True
-            section_item = QTreeWidgetItem([section_label, ""])
+            section_item = QTreeWidgetItem([section_label, "", ""])
             section_item.setData(0, Qt.UserRole, "section")
             section_font = section_item.font(0)
             section_font.setBold(True)
             section_item.setFont(0, section_font)
             section_item.setFirstColumnSpanned(True)
             self.history_detail_tree.addTopLevelItem(section_item)
             for detail in items:
                 test_name = detail.get("test") or "—"
                 display_name = test_name
-                detail_text = self._build_exam_detail_text(
-                    test_name,
-                    detail.get("raw_result"),
-                    context=detail_context,
-                    observation=detail.get("observation"),
-                    issue=detail.get("issue"),
-                    cancel_reason=detail.get("cancel_reason")
-                )
-                summary_text = build_result_display(detail, test_name)
-                test_item = QTreeWidgetItem([display_name, ""])
+                parameter_rows = build_parameter_rows(detail, test_name)
+                test_item = QTreeWidgetItem([display_name, "", ""])
                 test_item.setData(0, Qt.UserRole, "exam")
                 test_item.setToolTip(0, test_name)
-                summary_label = QLabel(summary_text)
-                summary_label.setWordWrap(True)
-                summary_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)
-                summary_label.setMinimumWidth(0)
-                summary_label.setToolTip(summary_text)
-                summary_label.setStyleSheet("padding: 2px 0;")
-                self.history_detail_tree.setItemWidget(test_item, 1, summary_label)
                 section_item.addChild(test_item)
-                if detail_text:
-                    detail_item = QTreeWidgetItem(["", ""])
-                    detail_item.setData(0, Qt.UserRole, "detail")
-                    detail_item.setFirstColumnSpanned(True)
-                    detail_label = QLabel(html.escape(detail_text).replace("\n", "<br>"))
-                    detail_label.setWordWrap(True)
-                    detail_label.setTextFormat(Qt.RichText)
-                    detail_label.setStyleSheet("color: #444; padding: 6px 8px;")
-                    self.history_detail_tree.setItemWidget(detail_item, 0, detail_label)
-                    test_item.addChild(detail_item)
-                test_item.setExpanded(bool(detail_text))
+                for row in parameter_rows:
+                    param_item = QTreeWidgetItem(["", row["param"], ""])
+                    param_item.setData(0, Qt.UserRole, "param")
+                    result_text = str(row["result"])
+                    result_label = QLabel(result_text)
+                    result_label.setWordWrap(True)
+                    result_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)
+                    result_label.setMinimumWidth(0)
+                    result_label.setToolTip(result_text)
+                    result_label.setTextFormat(Qt.PlainText)
+                    result_label.setStyleSheet("padding: 2px 0;")
+                    self.history_detail_tree.setItemWidget(param_item, 2, result_label)
+                    test_item.addChild(param_item)
+                test_item.setExpanded(True)
             section_item.setExpanded(True)
         if any_rows:
             self.history_detail_tree.show()
             self.history_detail_empty.hide()
         else:
             self.history_detail_tree.hide()
             self.history_detail_empty.show()
 
     def _toggle_history_detail_item(self, item, column):
         if not item or item.data(0, Qt.UserRole) != "exam":
             return
         item.setExpanded(not item.isExpanded())
 
     def _update_history_detail_from_selection(self):
         entry = self._get_selected_history_entry()
         if not entry:
             self._render_history_detail([])
             return
         self._render_history_detail(entry)
 
 
     def _on_history_selection_changed(self):
         if not hasattr(self, 'history_table'):
             return
         selection = self.history_table.selectionModel()
 
EOF
)