 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/main_window.py b/main_window.py
index 1dad81ed52eb4625c85996b453e65cec8d475b00..bbd7cba7eabd5e2ad667ffa7cc6d523718d63ec2 100644
--- a/main_window.py
+++ b/main_window.py
@@ -5522,61 +5522,59 @@ class MainWindow(QMainWindow):
         self.history_alerts_panel = QGroupBox("Alertas clínicas")
         alerts_layout = QVBoxLayout(self.history_alerts_panel)
         alerts_layout.setContentsMargins(6, 6, 6, 6)
         alerts_layout.setSpacing(4)
         self.history_alerts_placeholder = QLabel("Sin alertas registradas.")
         self.history_alerts_placeholder.setStyleSheet("color: #666; padding: 6px;")
         self.history_alerts_container = QWidget()
         self.history_alerts_grid = QGridLayout(self.history_alerts_container)
         self.history_alerts_grid.setContentsMargins(6, 6, 6, 6)
         self.history_alerts_grid.setHorizontalSpacing(6)
         self.history_alerts_grid.setVerticalSpacing(6)
         alerts_scroll = QScrollArea()
         alerts_scroll.setWidgetResizable(True)
         alerts_scroll.setFrameShape(QFrame.NoFrame)
         alerts_scroll.setWidget(self.history_alerts_container)
         alerts_layout.addWidget(self.history_alerts_placeholder)
         alerts_layout.addWidget(alerts_scroll)
         self.history_has_alerts = False
 
         self.history_detail_panel = QGroupBox("Detalle de la orden / Exámenes")
         detail_layout = QVBoxLayout(self.history_detail_panel)
         self.history_detail_empty = QLabel("Sin exámenes registrados en esta orden.")
         self.history_detail_empty.setAlignment(Qt.AlignCenter)
         self.history_detail_empty.setStyleSheet("color: #666; padding: 12px;")
         self.history_detail_tree = QTreeWidget()
-        self.history_detail_tree.setHeaderLabels(["Examen", "Resultado principal", "Estado", "Hora"])
+        self.history_detail_tree.setHeaderLabels(["Examen", "Resultado"])
         self.history_detail_tree.setRootIsDecorated(False)
         self.history_detail_tree.setAlternatingRowColors(True)
         self.history_detail_tree.setItemsExpandable(True)
         self.history_detail_tree.setUniformRowHeights(False)
         self.history_detail_tree.setTextElideMode(Qt.ElideNone)
         header = self.history_detail_tree.header()
         header.setSectionResizeMode(0, QHeaderView.ResizeToContents)
         header.setSectionResizeMode(1, QHeaderView.Stretch)
-        header.setSectionResizeMode(2, QHeaderView.ResizeToContents)
-        header.setSectionResizeMode(3, QHeaderView.ResizeToContents)
         self.history_detail_tree.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
         self.history_detail_tree.itemClicked.connect(self._toggle_history_detail_item)
         detail_layout.addWidget(self.history_detail_empty)
         detail_layout.addWidget(self.history_detail_tree)
 
         self.history_combined_panel = QFrame()
         self.history_combined_panel.setFrameShape(QFrame.NoFrame)
         combined_layout = QVBoxLayout(self.history_combined_panel)
         combined_layout.setContentsMargins(0, 0, 0, 0)
         combined_layout.setSpacing(8)
         combined_layout.addWidget(self.history_alerts_panel)
         combined_layout.addWidget(self.history_detail_panel)
         self.history_combined_layout = combined_layout
 
         self.history_mobile_toolbox = QToolBox()
 
         history_tab_layout.addWidget(history_workspace)
         history_tab_layout.addWidget(self.history_mobile_toolbox)
         self.history_mobile_toolbox.hide()
         self.analysis_tabs.addTab(history_tab, "Historial de pacientes")
         self._stats_controls_ready = False
         self.stats_mode_combo.currentIndexChanged.connect(self._update_stats_period_controls)
         self.stats_month_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_quarter_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_year_spin.valueChanged.connect(lambda _: self.refresh_statistics())
@@ -6750,107 +6748,103 @@ class MainWindow(QMainWindow):
         }
         sections = OrderedDict([
             ("results", "Realizado"),
             ("in_process", "En proceso"),
             ("pending", "Pendiente"),
             ("cancelled", "Anulado"),
         ])
         grouped = {key: [] for key in sections}
         order_emitted = bool(entry.get("emitted")) if isinstance(entry, dict) else False
         for item in detail_items:
             sample_status = (item.get("sample_status") or "").strip().lower()
             is_cancelled = bool(item.get("is_cancelled")) or sample_status == "anulado"
             is_rejected = sample_status == "rechazada"
             has_result = bool(item.get("has_result"))
             is_emitted = bool(item.get("is_emitted")) or order_emitted or sample_status in {"emitido", "validado"}
             if is_cancelled or is_rejected:
                 section_key = "cancelled"
             elif has_result or is_emitted:
                 section_key = "results"
             elif item.get("sample_received"):
                 section_key = "in_process"
             else:
                 section_key = "pending"
             grouped[section_key].append(item)
         any_rows = False
+        def build_result_display(detail_item, test_name):
+            raw_result = detail_item.get("raw_result")
+            if self._is_blank_result(raw_result):
+                return "Resultado no registrado"
+            parsed = self._parse_stored_result(raw_result)
+            if parsed.get("type") == "structured":
+                lines = self._format_result_lines(test_name, raw_result, context=detail_context)
+                if lines:
+                    return " | ".join(lines)
+            text_value = parsed.get("value", raw_result or "")
+            if isinstance(text_value, str):
+                text_value = text_value.strip()
+            if text_value:
+                return str(text_value)
+            return "Resultado no registrado"
+
         for section_key, section_label in sections.items():
             items = grouped.get(section_key, [])
             if not items:
                 continue
             any_rows = True
-            section_item = QTreeWidgetItem([section_label, "", "", ""])
+            section_item = QTreeWidgetItem([section_label, ""])
             section_item.setData(0, Qt.UserRole, "section")
             section_font = section_item.font(0)
             section_font.setBold(True)
             section_item.setFont(0, section_font)
+            section_item.setFirstColumnSpanned(True)
             self.history_detail_tree.addTopLevelItem(section_item)
             for detail in items:
                 test_name = detail.get("test") or "—"
                 abbr = self._abbreviate_exam_name(test_name)
-                status_label = section_label
-                badge = QLabel(status_label)
-                if section_key == "results":
-                    badge.setStyleSheet("QLabel { background-color: #e6f7ef; color: #1e8449; border-radius: 8px; padding: 2px 8px; font-weight: 600; }")
-                elif section_key == "in_process":
-                    badge.setStyleSheet("QLabel { background-color: #e7f3ff; color: #1f4e79; border-radius: 8px; padding: 2px 8px; font-weight: 600; }")
-                elif section_key == "pending":
-                    badge.setStyleSheet("QLabel { background-color: #fff1cc; color: #7a4d00; border-radius: 8px; padding: 2px 8px; font-weight: 600; }")
-                else:
-                    badge.setStyleSheet("QLabel { background-color: #f0f0f0; color: #7f8c8d; border-radius: 8px; padding: 2px 8px; font-weight: 600; }")
-                time_value = None
-                if section_key == "results":
-                    time_value = detail.get("validated_at") or detail.get("emitted_at")
-                elif section_key == "pending":
-                    time_value = detail.get("pending_since")
-                elif section_key == "in_process":
-                    time_value = detail.get("sample_date_raw")
-                time_display = self._format_time_display(time_value) if time_value else ""
-                if time_display == "00:00":
-                    time_display = ""
                 detail_text = self._build_exam_detail_text(
                     test_name,
                     detail.get("raw_result"),
                     context=detail_context,
                     observation=detail.get("observation"),
                     issue=detail.get("issue"),
                     cancel_reason=detail.get("cancel_reason")
                 )
-                summary_text = self.buildResultSummary(detail, detail_text)
-                test_item = QTreeWidgetItem([abbr, "", "", time_display])
+                summary_text = build_result_display(detail, test_name)
+                test_item = QTreeWidgetItem([abbr, ""])
                 test_item.setData(0, Qt.UserRole, "exam")
                 test_item.setToolTip(0, test_name)
                 summary_label = QLabel(summary_text)
                 summary_label.setWordWrap(True)
                 summary_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)
                 summary_label.setMinimumWidth(0)
                 summary_label.setToolTip(summary_text)
                 summary_label.setStyleSheet("padding: 2px 0;")
                 self.history_detail_tree.setItemWidget(test_item, 1, summary_label)
-                self.history_detail_tree.setItemWidget(test_item, 2, badge)
                 section_item.addChild(test_item)
                 if detail_text:
-                    detail_item = QTreeWidgetItem(["", "", "", ""])
+                    detail_item = QTreeWidgetItem(["", ""])
                     detail_item.setData(0, Qt.UserRole, "detail")
                     detail_item.setFirstColumnSpanned(True)
                     detail_label = QLabel(html.escape(detail_text).replace("\n", "<br>"))
                     detail_label.setWordWrap(True)
                     detail_label.setTextFormat(Qt.RichText)
                     detail_label.setStyleSheet("color: #444; padding: 6px 8px;")
                     self.history_detail_tree.setItemWidget(detail_item, 0, detail_label)
                     test_item.addChild(detail_item)
                 test_item.setExpanded(bool(detail_text))
             section_item.setExpanded(True)
         if any_rows:
             self.history_detail_tree.show()
             self.history_detail_empty.hide()
         else:
             self.history_detail_tree.hide()
             self.history_detail_empty.show()
 
     def _toggle_history_detail_item(self, item, column):
         if not item or item.data(0, Qt.UserRole) != "exam":
             return
         item.setExpanded(not item.isExpanded())
 
     def _update_history_detail_from_selection(self):
         entry = self._get_selected_history_entry()
         if not entry:
 
EOF
)