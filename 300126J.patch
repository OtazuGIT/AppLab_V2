 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/database.py b/database.py
index 718acb0e897f04b31ec3ca0572c27ce1c6a92a7f..ce7817e4a80d6bd0ddacd1db207c6121c7fe6954 100644
--- a/database.py
+++ b/database.py
@@ -4,50 +4,73 @@ import json
 import sqlite3
 from collections import OrderedDict
 class LabDB:
     def __init__(self, db_path="lab_db.sqlite"):
         self.db_path = db_path
         self.conn = None
         self.cur = None
         self.test_map = {}
         self.referential_tests = {
             "BK (resultado referencial)",
             "Serología Dengue (referencial)",
             "Serología Leptospira (referencial)",
             "Serología Leishmaniasis (referencial)",
         }
         self._referential_lookup = {name.lower().strip() for name in self.referential_tests}
     def connect(self):
         self.conn = sqlite3.connect(self.db_path)
         self.cur = self.conn.cursor()
         self.cur.execute("PRAGMA foreign_keys = ON")
         self.conn.commit()
 
     def _is_referential_test(self, test_name):
         if not test_name:
             return False
         return test_name.strip().lower() in self._referential_lookup
+
+    def _resolve_test_id(self, test_name):
+        if not test_name:
+            return None
+        raw_name = test_name
+        normalized = test_name.strip()
+        for candidate in (raw_name, normalized):
+            if candidate in self.test_map:
+                return self.test_map[candidate]
+        if not normalized:
+            return None
+        self.cur.execute("SELECT id, name FROM tests WHERE name=?", (normalized,))
+        row = self.cur.fetchone()
+        if not row:
+            self.cur.execute("SELECT id, name FROM tests WHERE LOWER(name)=LOWER(?)", (normalized,))
+            row = self.cur.fetchone()
+        if row:
+            test_id, db_name = row
+            self.test_map[db_name] = test_id
+            if normalized != db_name:
+                self.test_map[normalized] = test_id
+            return test_id
+        return None
     def init_db(self):
         # Crear tablas
         self.cur.execute("""
             CREATE TABLE IF NOT EXISTS users (
                 id INTEGER PRIMARY KEY AUTOINCREMENT,
                 username TEXT UNIQUE,
                 password TEXT,
                 role TEXT
             )
         """)
         self._ensure_column_exists("users", "full_name", "TEXT")
         self._ensure_column_exists("users", "profession", "TEXT")
         self._ensure_column_exists("users", "license", "TEXT")
         self.cur.execute("""
             CREATE TABLE IF NOT EXISTS patients (
                 id INTEGER PRIMARY KEY AUTOINCREMENT,
                 doc_type TEXT,
                 doc_number TEXT,
                 first_name TEXT,
                 last_name TEXT,
                 birth_date TEXT,
                 sex TEXT,
                 origin TEXT,
                 hcl TEXT,
                 height REAL,
@@ -409,60 +432,61 @@ class LabDB:
         fua_number=None,
         age_years=None,
         sample_date=None
     ):
         import datetime
         date_str = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
         sample_date_str = None
         if sample_date:
             sample_date_str = str(sample_date)
         age_value = None
         if age_years is not None:
             try:
                 age_value = int(age_years)
             except (TypeError, ValueError):
                 age_value = None
         insurance_value = (insurance_type or "SIS").strip() or "SIS"
         fua_value = fua_number.strip() if isinstance(fua_number, str) else fua_number
         if isinstance(fua_value, str) and fua_value == "":
             fua_value = None
         self.cur.execute("""
             INSERT INTO orders(patient_id, date, sample_date, created_by, observations, requested_by, diagnosis, insurance_type, fua_number, age_years, completed)
             VALUES (?,?,?,?,?,?,?,?,?,?,?)
         """, (patient_id, date_str, sample_date_str, user_id, observations, requested_by, diagnosis, insurance_value, fua_value, age_value, 0))
         order_id = self.cur.lastrowid
         for name in test_names:
-            if name in self.test_map:
-                test_id = self.test_map[name]
-                status = "pendiente" if self._is_referential_test(name) else "recibida"
-                pending_since = None
-                if status == "pendiente":
-                    pending_since = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
-                self.cur.execute(
-                    "INSERT INTO order_tests(order_id, test_id, result, sample_status, pending_since) VALUES (?,?,?,?,?)",
-                    (order_id, test_id, "", status, pending_since)
-                )
+            test_id = self._resolve_test_id(name)
+            if not test_id:
+                continue
+            status = "pendiente" if self._is_referential_test(name) else "recibida"
+            pending_since = None
+            if status == "pendiente":
+                pending_since = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
+            self.cur.execute(
+                "INSERT INTO order_tests(order_id, test_id, result, sample_status, pending_since) VALUES (?,?,?,?,?)",
+                (order_id, test_id, "", status, pending_since)
+            )
         self.conn.commit()
         return order_id
     def find_recent_duplicate_order(self, patient_id, test_names, within_minutes=10):
         if not patient_id or not test_names:
             return None
         normalized_target = sorted(name.strip().lower() for name in test_names if name)
         if not normalized_target:
             return None
         import datetime
         threshold = datetime.datetime.now() - datetime.timedelta(minutes=within_minutes)
         self.cur.execute(
             """
             SELECT id FROM orders
             WHERE patient_id=?
               AND datetime(date) >= datetime(?)
               AND (deleted IS NULL OR deleted=0)
             ORDER BY datetime(date) DESC, id DESC
             """,
             (patient_id, threshold.strftime("%Y-%m-%d %H:%M:%S"))
         )
         candidate_ids = [row[0] for row in self.cur.fetchall()]
         for oid in candidate_ids:
             self.cur.execute(
                 """
                 SELECT t.name
@@ -779,56 +803,51 @@ class LabDB:
             test_id = self.test_map.get(test_name)
             if test_id:
                 self.cur.execute(
                     "DELETE FROM order_tests WHERE order_id=? AND test_id=?",
                     (source_order_id, test_id),
                 )
         self.conn.commit()
         new_order_id = self.add_order_with_tests(
             patient_id,
             [entry["name"] for entry in tests_to_add],
             user_id,
             observations=observations,
             requested_by=requested_by or "",
             diagnosis=diagnosis or "",
             insurance_type=insurance_type or "SIS",
             fua_number=fua_number,
             age_years=age_years,
             sample_date=None
         )
         updated_completion = self._update_order_completion(source_order_id)
         return new_order_id, updated_completion
 
     def remove_test_from_order(self, order_id, test_name):
         if not test_name:
             return False
-        if test_name not in self.test_map:
-            self.cur.execute("SELECT id FROM tests WHERE name=?", (test_name,))
-            row = self.cur.fetchone()
-            if row:
-                self.test_map[test_name] = row[0]
-        tid = self.test_map.get(test_name)
+        tid = self._resolve_test_id(test_name)
         if not tid:
             return False
         self.cur.execute("DELETE FROM order_tests WHERE order_id=? AND test_id=?", (order_id, tid))
         if self.cur.rowcount:
             self._update_order_completion(order_id)
             return True
         self.conn.commit()
         return False
 
     def _update_order_completion(self, order_id):
         self.cur.execute(
             """
             SELECT result, sample_status
             FROM order_tests
             WHERE order_id=? AND (deleted IS NULL OR deleted=0)
             """,
             (order_id,)
         )
         rows = self.cur.fetchall()
         if not rows:
             completed_flag = 1
         else:
             missing_results = 0
             for result, sample_status in rows:
                 status = (sample_status or "recibida").strip().lower()
@@ -958,74 +977,70 @@ class LabDB:
         self.cur.execute(f"PRAGMA table_info({table_name})")
         columns = [info[1] for info in self.cur.fetchall()]
         if column_name not in columns:
             alter_sql = f"ALTER TABLE {table_name} ADD COLUMN {column_name} {column_type}"
             if default_value is not None:
                 alter_sql += f" DEFAULT '{default_value}'"
             self.cur.execute(alter_sql)
             self.conn.commit()
 
     def get_all_tests(self):
         self.cur.execute("SELECT name, category FROM tests ORDER BY category, name")
         return self.cur.fetchall()
 
     def get_tests_for_order(self, order_id):
         self.cur.execute("""
             SELECT t.name FROM order_tests ot
             JOIN tests t ON ot.test_id = t.id
             WHERE ot.order_id=?
         """, (order_id,))
         return [row[0] for row in self.cur.fetchall()]
 
     def add_tests_to_order(self, order_id, test_names):
         if not test_names:
             return []
         self.cur.execute("""
-            SELECT t.name FROM order_tests ot
-            JOIN tests t ON ot.test_id = t.id
+            SELECT ot.test_id FROM order_tests ot
             WHERE ot.order_id=?
         """, (order_id,))
-        existing = {row[0] for row in self.cur.fetchall()}
+        existing_ids = {row[0] for row in self.cur.fetchall()}
         added = []
         for name in test_names:
-            if name not in self.test_map:
-                self.cur.execute("SELECT id FROM tests WHERE name=?", (name,))
-                row = self.cur.fetchone()
-                if row:
-                    self.test_map[name] = row[0]
-            if name in self.test_map and name not in existing:
-                test_id = self.test_map[name]
-                status = "pendiente" if self._is_referential_test(name) else "recibida"
-                pending_since = None
-                if status == "pendiente":
-                    import datetime
-                    pending_since = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
-                self.cur.execute(
-                    "INSERT INTO order_tests(order_id, test_id, result, sample_status, pending_since) VALUES (?,?,?,?,?)",
-                    (order_id, test_id, "", status, pending_since)
-                )
-                added.append(name)
+            test_id = self._resolve_test_id(name)
+            if not test_id or test_id in existing_ids:
+                continue
+            status = "pendiente" if self._is_referential_test(name) else "recibida"
+            pending_since = None
+            if status == "pendiente":
+                import datetime
+                pending_since = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
+            self.cur.execute(
+                "INSERT INTO order_tests(order_id, test_id, result, sample_status, pending_since) VALUES (?,?,?,?,?)",
+                (order_id, test_id, "", status, pending_since)
+            )
+            added.append(name)
+            existing_ids.add(test_id)
         if added:
             self.cur.execute("UPDATE orders SET completed=0 WHERE id=?", (order_id,))
         self.conn.commit()
         return added
 
     def update_order_fua(self, order_id, fua_number):
         if not order_id:
             return False
         value = fua_number.strip() if isinstance(fua_number, str) else fua_number
         if isinstance(value, str) and value == "":
             value = None
         self.cur.execute("SELECT id FROM orders WHERE id=?", (order_id,))
         if not self.cur.fetchone():
             return False
         self.cur.execute(
             "UPDATE orders SET fua_number=? WHERE id=?",
             (value, order_id)
         )
         self.conn.commit()
         return True
 
     def get_patient_history(self, doc_number=None, doc_type=None, last_name=None):
         if not doc_number and not last_name:
             return []
         params = []
 
EOF
)