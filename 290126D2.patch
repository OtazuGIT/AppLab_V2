 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/main_window.py b/main_window.py
index 00201b7a622ebbca5dc8f43627e4ca053ba7ac8d..9c4f55f913ec81db8142e557a1682497dfa0a23d 100644
--- a/main_window.py
+++ b/main_window.py
@@ -1,43 +1,43 @@
 # main_window.py
 import copy
 import datetime
 import html
 import inspect
 import json
 import os
 import re
 import unicodedata
 from collections import OrderedDict
 from PyQt5.QtWidgets import (QMainWindow, QWidget, QLabel, QPushButton, QVBoxLayout, QHBoxLayout,
                              QStackedWidget, QTabWidget, QFormLayout, QScrollArea, QGroupBox, QComboBox,
                              QLineEdit, QTextEdit, QTableWidget, QTableWidgetItem, QFileDialog, QMessageBox, QCheckBox,
                              QDateEdit, QRadioButton, QButtonGroup, QDialog, QDialogButtonBox, QListWidget, QListWidgetItem,
                              QSpinBox, QInputDialog, QAbstractItemView, QGridLayout, QToolButton, QFrame, QSizePolicy,
                              QTreeWidget, QTreeWidgetItem, QStyle, QToolBox)
 from PyQt5.QtCore import QDate, QDateTime, Qt, QTimer
-from PyQt5.QtGui import QColor, QFont
+from PyQt5.QtGui import QColor, QFont, QBrush
 from fpdf import FPDF  # Asegúrese de tener fpdf instalado (pip install fpdf)
 from openpyxl import Workbook
 
 LAB_TITLE = "Laboratorio P.S. Iñapari - 002789"
 
 MONTH_NAMES_ES = [
     "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
     "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
 ]
 
 CATEGORY_DISPLAY_ORDER = [
     "HEMATOLOGÍA",
     "BIOQUÍMICA",
     "INMUNOLOGÍA",
     "PRUEBAS RÁPIDAS",
     "PARASITOLOGÍA",
     "MICROBIOLOGÍA",
     "MICROSCOPÍA",
     "LABORATORIO REFERENCIAL",
     "OTROS",
     "TOMA DE MUESTRA"
 ]
 
 REGISTRY_ABBREVIATIONS = {
     "hematocrito": "Hto",
@@ -3410,52 +3410,50 @@ class MainWindow(QMainWindow):
         normalized = (category or "").strip().upper()
         if normalized == "HEMATOLOGÍA":
             return "hematology"
         if normalized == "BIOQUÍMICA":
             return "biochemistry"
         if normalized in {"MICROBIOLOGÍA", "PARASITOLOGÍA", "MICROSCOPÍA"}:
             return "micro_parasito"
         if normalized == "LABORATORIO REFERENCIAL":
             return "others"
         return "others"
 
     def _aggregate_results_by_order(self, records):
         group_keys = ["hematology", "biochemistry", "micro_parasito", "others"]
         aggregated = []
         grouped = OrderedDict()
         for record in records:
             summary_items = record.get("summary_items") or []
             has_result = bool(record.get("has_result"))
             sample_received = bool(record.get("sample_received"))
             if not summary_items and not sample_received:
                 result_value = record.get("result", "")
                 if isinstance(result_value, str) and result_value.strip():
                     summary_items = [result_value.strip()]
                 elif not self._is_blank_result(result_value):
                     summary_items = [str(result_value)]
-            if not summary_items and not sample_received:
-                continue
             order_id = record.get("order_id")
             if order_id is None:
                 continue
             entry = grouped.get(order_id)
             if not entry:
                 entry = {
                     "order_id": order_id,
                     "date": record.get("date", ""),
                     "order_date_raw": record.get("order_date_raw"),
                     "sample_date_raw": record.get("sample_date_raw"),
                     "patient": record.get("patient", ""),
                     "document": record.get("document", ""),
                     "doc_type": record.get("doc_type"),
                     "doc_number": record.get("doc_number"),
                     "birth_date": record.get("birth_date"),
                     "hcl": record.get("hcl"),
                     "height": record.get("height"),
                     "weight": record.get("weight"),
                     "blood_pressure": record.get("blood_pressure"),
                     "sex": record.get("sex"),
                     "origin": record.get("origin"),
                     "is_pregnant": record.get("is_pregnant"),
                     "gestational_age_weeks": record.get("gestational_age_weeks"),
                     "expected_delivery_date": record.get("expected_delivery_date"),
                     "age": record.get("age", ""),
@@ -3470,78 +3468,86 @@ class MainWindow(QMainWindow):
                     "groups": {key: [] for key in group_keys},
                     "tests": [],
                     "sample_statuses": [],
                     "pending_tests": [],
                     "test_detail_map": OrderedDict()
                 }
                 grouped[order_id] = entry
             group_key = self._map_category_group(record.get("category"))
             if has_result:
                 for item in summary_items:
                     cleaned = str(item).strip()
                     if cleaned:
                         entry["groups"].setdefault(group_key, []).append(cleaned)
             test_name = record.get("test")
             if test_name:
                 test_clean = str(test_name).strip()
                 if test_clean and test_clean not in entry.setdefault("tests", []):
                     entry["tests"].append(test_clean)
                 detail_map = entry.setdefault("test_detail_map", OrderedDict())
                 detail_entry = detail_map.get(test_clean, {
                     "test": test_clean,
                     "group": group_key,
                     "summary_items": [],
                     "has_result": False,
                     "sample_received": False,
+                    "sample_status": None,
+                    "is_cancelled": False,
+                    "cancel_reason": None,
+                    "is_emitted": False,
                     "issue": None,
                     "is_critical": False
                 })
                 if summary_items and has_result:
                     detail_entry["summary_items"] = summary_items
                 detail_entry["has_result"] = detail_entry["has_result"] or has_result
                 detail_entry["sample_received"] = detail_entry["sample_received"] or sample_received
+                detail_entry["sample_status"] = record.get("sample_status") or detail_entry.get("sample_status")
+                detail_entry["is_cancelled"] = detail_entry.get("is_cancelled") or bool(record.get("is_cancelled"))
+                detail_entry["cancel_reason"] = record.get("cancel_reason") or detail_entry.get("cancel_reason")
+                detail_entry["is_emitted"] = detail_entry.get("is_emitted") or bool(record.get("emitted"))
                 detail_entry["issue"] = record.get("sample_issue") or detail_entry.get("issue")
                 detail_entry["is_critical"] = detail_entry["is_critical"] or bool(record.get("is_critical"))
                 detail_map[test_clean] = detail_entry
             if sample_received and not has_result and test_name:
                 entry.setdefault("pending_tests", []).append(test_name)
             status_info = {
                 "test": record.get("test"),
                 "status": record.get("sample_status"),
                 "issue": record.get("sample_issue"),
                 "pending_since": record.get("pending_since"),
             }
             entry.setdefault("sample_statuses", []).append(status_info)
         for entry in grouped.values():
             obs_text = entry.get("observations")
             if obs_text:
                 obs_clean = " ".join(str(obs_text).split())
                 if obs_clean and obs_clean.lower() not in {"n/a", "na", "-"}:
                     entry["groups"].setdefault("others", []).append(f"Obs: {obs_clean}")
             if "test_detail_map" in entry:
                 entry["test_details"] = list(entry["test_detail_map"].values())
-            if any(entry["groups"].get(key) for key in group_keys) or entry.get("pending_tests"):
+            if entry.get("test_detail_map"):
                 aggregated.append(entry)
         return aggregated
 
     def _format_short_date(self, value):
         return self._format_date_display(value, "—")
 
     def _format_patient_block_for_registry(self, entry):
         def clean(text):
             if not text:
                 return ""
             return " ".join(str(text).split())
         def to_title(text):
             return text.title() if text else ""
         first = to_title(clean(entry.get("first_name")))
         last = to_title(clean(entry.get("last_name")))
         if last and first:
             name_line = f"{last}, {first}"
         elif last:
             name_line = last
         elif first:
             name_line = first
         else:
             fallback = clean(entry.get("patient"))
             name_line = to_title(fallback) if fallback else "—"
         doc_type_value = entry.get("doc_type")
@@ -5094,71 +5100,51 @@ class MainWindow(QMainWindow):
         patient_container_layout.addWidget(self.history_patient_summary_label)
         patient_scroll.setWidget(patient_container)
         patient_layout.addWidget(patient_scroll)
 
         self.history_alerts_panel = QGroupBox("Alertas clínicas")
         alerts_layout = QVBoxLayout(self.history_alerts_panel)
         alerts_layout.setContentsMargins(6, 6, 6, 6)
         alerts_layout.setSpacing(4)
         self.history_alerts_placeholder = QLabel("Sin alertas registradas.")
         self.history_alerts_placeholder.setStyleSheet("color: #666; padding: 6px;")
         self.history_alerts_container = QWidget()
         self.history_alerts_grid = QGridLayout(self.history_alerts_container)
         self.history_alerts_grid.setContentsMargins(6, 6, 6, 6)
         self.history_alerts_grid.setHorizontalSpacing(6)
         self.history_alerts_grid.setVerticalSpacing(6)
         alerts_scroll = QScrollArea()
         alerts_scroll.setWidgetResizable(True)
         alerts_scroll.setFrameShape(QFrame.NoFrame)
         alerts_scroll.setWidget(self.history_alerts_container)
         alerts_layout.addWidget(self.history_alerts_placeholder)
         alerts_layout.addWidget(alerts_scroll)
         self.history_has_alerts = False
 
         self.history_detail_panel = QGroupBox("Detalle de la orden / Exámenes")
         detail_layout = QVBoxLayout(self.history_detail_panel)
-        detail_toolbar = QHBoxLayout()
-        detail_toolbar.addWidget(QLabel("Filtros:"))
-        self.history_detail_filter_group = QButtonGroup(self)
-        self.history_detail_filter_group.setExclusive(True)
-        self.history_filter_done_btn = QToolButton()
-        self.history_filter_done_btn.setText("Todos realizados")
-        self.history_filter_done_btn.setCheckable(True)
-        self.history_filter_done_btn.setChecked(True)
-        self.history_filter_pending_btn = QToolButton()
-        self.history_filter_pending_btn.setText("Pendientes con muestra")
-        self.history_filter_pending_btn.setCheckable(True)
-        self.history_filter_critical_btn = QToolButton()
-        self.history_filter_critical_btn.setText("Críticos")
-        self.history_filter_critical_btn.setCheckable(True)
-        for btn in (self.history_filter_done_btn, self.history_filter_pending_btn, self.history_filter_critical_btn):
-            btn.setToolButtonStyle(Qt.ToolButtonTextOnly)
-            self.history_detail_filter_group.addButton(btn)
-            detail_toolbar.addWidget(btn)
-        detail_toolbar.addStretch()
-        detail_layout.addLayout(detail_toolbar)
-        self.history_detail_empty = QLabel("Sin exámenes realizados/recibidos en esta orden.")
+        self.history_detail_empty = QLabel("Sin exámenes registrados en esta orden.")
         self.history_detail_empty.setAlignment(Qt.AlignCenter)
         self.history_detail_empty.setStyleSheet("color: #666; padding: 12px;")
         self.history_detail_tree = QTreeWidget()
         self.history_detail_tree.setHeaderLabels(["Examen", "Estado/Resultado"])
         self.history_detail_tree.setRootIsDecorated(True)
         self.history_detail_tree.setAlternatingRowColors(True)
         self.history_detail_tree.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
         detail_layout.addWidget(self.history_detail_empty)
         detail_layout.addWidget(self.history_detail_tree)
 
         self.history_combined_panel = QFrame()
         self.history_combined_panel.setFrameShape(QFrame.NoFrame)
         combined_layout = QVBoxLayout(self.history_combined_panel)
         combined_layout.setContentsMargins(0, 0, 0, 0)
         combined_layout.setSpacing(8)
         combined_layout.addWidget(self.history_alerts_panel)
         combined_layout.addWidget(self.history_detail_panel)
         self.history_combined_layout = combined_layout
 
         self.history_mobile_toolbox = QToolBox()
 
         history_tab_layout.addWidget(history_workspace)
         history_tab_layout.addWidget(self.history_mobile_toolbox)
         self.history_mobile_toolbox.hide()
         self.analysis_tabs.addTab(history_tab, "Historial de pacientes")
@@ -5167,51 +5153,50 @@ class MainWindow(QMainWindow):
         self.stats_month_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_quarter_combo.currentIndexChanged.connect(lambda _: self.refresh_statistics())
         self.stats_year_spin.valueChanged.connect(lambda _: self.refresh_statistics())
         self._history_results = []
         self.range_combo.currentIndexChanged.connect(self._update_range_controls)
         self.activity_search_input.textChanged.connect(self.apply_activity_filter)
         self.view_activity_btn.clicked.connect(self.load_activity_summary)
         self.export_activity_pdf_btn.clicked.connect(lambda: self.export_activity_record("pdf"))
         self.export_activity_csv_btn.clicked.connect(lambda: self.export_activity_record("csv"))
         self.export_activity_excel_btn.clicked.connect(lambda: self.export_activity_record("xlsx"))
         self.export_activity_delivery_btn.clicked.connect(self.export_activity_delivery_sheet)
         self.delete_activity_btn.clicked.connect(self.delete_selected_activity_entries)
         self.activity_min_age_spin.valueChanged.connect(self.apply_activity_filter)
         self.activity_max_age_spin.valueChanged.connect(self.apply_activity_filter)
         self.activity_test_filter.currentIndexChanged.connect(self.apply_activity_filter)
         self._update_range_controls()
         self._stats_controls_ready = True
         self._update_stats_period_controls()
         self.history_doc_input.returnPressed.connect(self.search_patient_history)
         self.history_lastname_input.returnPressed.connect(self.search_patient_history)
         self.history_search_btn.clicked.connect(self.search_patient_history)
         self.history_open_btn.clicked.connect(self.open_history_order_from_analysis)
         self.history_table.itemSelectionChanged.connect(self._on_history_selection_changed)
         self.history_fua_btn.clicked.connect(self.edit_history_fua)
         self.history_window_btn.clicked.connect(self.open_history_window)
-        self.history_detail_filter_group.buttonClicked.connect(self._update_history_detail_from_selection)
         if hasattr(self, 'history_tab'):
             def _history_tab_resize(event):
                 QWidget.resizeEvent(self.history_tab, event)
                 self._update_history_workspace_layout()
             self.history_tab.resizeEvent = _history_tab_resize
         self._update_history_workspace_layout()
     def refresh_statistics(self):
         if not getattr(self, '_stats_controls_ready', False):
             return
         period = self._get_statistics_period()
         start_dt = datetime.datetime.combine(period['start'], datetime.time(0, 0, 0))
         end_dt = datetime.datetime.combine(period['end'], datetime.time(23, 59, 59))
         stats = self.labdb.get_statistics(start_dt.isoformat(sep=' '), end_dt.isoformat(sep=' '))
         summary_lines = [
             f"Período: {period['label']}",
             f"Pacientes atendidos: {stats['total_patients']}",
             f"Órdenes realizadas: {stats['total_orders']}",
             f"Pruebas realizadas: {stats['total_tests_conducted']}"
         ]
         self.stats_label.setText("\n".join(summary_lines))
         self.stats_table.setRowCount(0)
         detail = stats.get('by_category_detail', OrderedDict())
         ordered_categories = [cat for cat in CATEGORY_DISPLAY_ORDER if cat in detail]
         remaining = [cat for cat in detail.keys() if cat not in ordered_categories]
         categories = ordered_categories + remaining
@@ -6282,118 +6267,150 @@ class MainWindow(QMainWindow):
             "Anticoagulación": ("#fff1cc", "#7a4d00"),
             "HTA": ("#fff1cc", "#7a4d00"),
             "DM": ("#fff1cc", "#7a4d00"),
             "Embarazo": ("#e8e1ff", "#4b2e83"),
             "Repetir muestra": ("#ffe7cc", "#8a4b08"),
             "Dx crónico": ("#e7f3ff", "#1f4e79"),
             "Exámenes pendientes hoy": ("#ffe7cc", "#8a4b08"),
         }
         for idx, tag in enumerate(tags):
             bg, fg = color_map.get(tag, ("#e7f3ff", "#1f4e79"))
             chip = QLabel(tag)
             chip.setStyleSheet(
                 f"QLabel {{ background-color: {bg}; color: {fg}; border-radius: 8px; padding: 3px 8px; }}"
             )
             chip.setSizePolicy(QSizePolicy.Maximum, QSizePolicy.Fixed)
             row = idx
             col = 0
             self.history_alerts_grid.addWidget(chip, row, col, Qt.AlignLeft)
         if prev_state != has_alerts:
             self._update_history_workspace_layout()
 
     def _render_history_detail(self, entry):
         if not hasattr(self, 'history_detail_tree'):
             return
         self.history_detail_tree.clear()
-        filter_mode = "done"
-        if hasattr(self, 'history_filter_pending_btn') and self.history_filter_pending_btn.isChecked():
-            filter_mode = "pending"
-        elif hasattr(self, 'history_filter_critical_btn') and self.history_filter_critical_btn.isChecked():
-            filter_mode = "critical"
+        self.history_detail_empty.setText("Sin exámenes registrados en esta orden.")
         detail_items = []
         if isinstance(entry, dict):
             detail_items = entry.get("test_details", [])
         if not detail_items:
             self.history_detail_tree.hide()
             self.history_detail_empty.show()
             return
-        grouped = OrderedDict()
         group_labels = OrderedDict([
             ("hematology", "Hematología"),
             ("biochemistry", "Bioquímica"),
             ("micro_parasito", "Micro/Parasitología"),
             ("others", "Otros exámenes"),
         ])
+        sections = OrderedDict([
+            ("results", "Resultados disponibles"),
+            ("in_process", "En proceso"),
+            ("pending", "Pendientes"),
+            ("no_processed", "No procesados"),
+        ])
+        grouped = {key: OrderedDict() for key in sections}
+        order_emitted = bool(entry.get("emitted")) if isinstance(entry, dict) else False
         for item in detail_items:
-            if filter_mode == "done" and not item.get("has_result"):
-                continue
-            if filter_mode == "pending" and (item.get("has_result") or not item.get("sample_received")):
-                continue
-            if filter_mode == "critical" and not item.get("is_critical"):
-                continue
+            sample_status = (item.get("sample_status") or "").strip().lower()
+            is_cancelled = bool(item.get("is_cancelled")) or sample_status == "anulado"
+            is_rejected = sample_status == "rechazada"
+            has_result = bool(item.get("has_result"))
+            is_emitted = bool(item.get("is_emitted")) or order_emitted or sample_status in {"emitido", "validado"}
+            if is_cancelled or is_rejected:
+                section_key = "no_processed"
+            elif has_result or is_emitted:
+                section_key = "results"
+            elif item.get("sample_received"):
+                section_key = "in_process"
+            else:
+                section_key = "pending"
             group_key = item.get("group") or "others"
-            grouped.setdefault(group_key, []).append(item)
+            grouped[section_key].setdefault(group_key, []).append(item)
         any_rows = False
-        for group_key, group_label in group_labels.items():
-            items = grouped.get(group_key, [])
-            if not items:
+        muted_brush = QBrush(QColor("#888"))
+        for section_key, section_label in sections.items():
+            section_groups = grouped.get(section_key, {})
+            if not any(section_groups.values()):
                 continue
             any_rows = True
-            group_item = QTreeWidgetItem([group_label, ""])
-            group_font = group_item.font(0)
-            group_font.setBold(True)
-            group_item.setFont(0, group_font)
-            self.history_detail_tree.addTopLevelItem(group_item)
-            for detail in items:
-                status_parts = []
-                if detail.get("has_result"):
-                    summary_items = detail.get("summary_items") or []
-                    if summary_items:
-                        status_parts.append("; ".join(summary_items))
+            section_item = QTreeWidgetItem([section_label, ""])
+            section_font = section_item.font(0)
+            section_font.setBold(True)
+            section_item.setFont(0, section_font)
+            self.history_detail_tree.addTopLevelItem(section_item)
+            for group_key, group_label in group_labels.items():
+                items = section_groups.get(group_key, [])
+                if not items:
+                    continue
+                group_item = QTreeWidgetItem([group_label, ""])
+                group_font = group_item.font(0)
+                group_font.setBold(True)
+                group_item.setFont(0, group_font)
+                section_item.addChild(group_item)
+                for detail in items:
+                    status_parts = []
+                    sample_status = (detail.get("sample_status") or "").strip().lower()
+                    is_cancelled = bool(detail.get("is_cancelled")) or sample_status == "anulado"
+                    is_rejected = sample_status == "rechazada"
+                    if is_cancelled:
+                        status_parts.append("Anulado")
+                        cancel_reason = detail.get("cancel_reason")
+                        if cancel_reason:
+                            status_parts.append(str(cancel_reason))
+                    elif is_rejected:
+                        status_parts.append("Rechazado")
+                    if detail.get("has_result"):
+                        summary_items = detail.get("summary_items") or []
+                        if summary_items:
+                            status_parts.append("; ".join(summary_items))
+                        else:
+                            status_parts.append("Resultado registrado")
+                    elif detail.get("is_emitted") or order_emitted or sample_status in {"emitido", "validado"}:
+                        status_parts.append("Emitido")
+                    elif detail.get("sample_received"):
+                        status_parts.append("Muestra recibida (en proceso)")
                     else:
-                        status_parts.append("Resultado registrado")
-                elif detail.get("sample_received"):
-                    status_parts.append("Recibida (pendiente resultado)")
-                issue = detail.get("issue")
-                if issue and not detail.get("has_result"):
-                    status_parts.append(str(issue))
-                status_text = " · ".join(status_parts) if status_parts else "—"
-                test_item = QTreeWidgetItem([detail.get("test") or "—", status_text])
-                group_item.addChild(test_item)
-            group_item.setExpanded(True)
-        if not any_rows:
-            if filter_mode == "critical":
-                self.history_detail_empty.setText("Sin resultados críticos en esta orden.")
-            elif filter_mode == "pending":
-                self.history_detail_empty.setText("No hay exámenes con muestra recibida pendiente.")
-            else:
-                self.history_detail_empty.setText("Sin exámenes realizados/recibidos en esta orden.")
-            self.history_detail_tree.hide()
-            self.history_detail_empty.show()
-        else:
+                        status_parts.append("Pendiente (sin muestra)")
+                    issue = detail.get("issue")
+                    if issue and not detail.get("has_result") and not is_cancelled:
+                        status_parts.append(str(issue))
+                    status_text = " · ".join(status_parts) if status_parts else "—"
+                    test_item = QTreeWidgetItem([detail.get("test") or "—", status_text])
+                    if section_key == "no_processed":
+                        test_item.setForeground(0, muted_brush)
+                        test_item.setForeground(1, muted_brush)
+                    group_item.addChild(test_item)
+                group_item.setExpanded(True)
+            section_item.setExpanded(True)
+        if any_rows:
             self.history_detail_tree.show()
             self.history_detail_empty.hide()
+        else:
+            self.history_detail_tree.hide()
+            self.history_detail_empty.show()
 
     def _update_history_detail_from_selection(self):
         entry = self._get_selected_history_entry()
         if not entry:
             self._render_history_detail([])
             return
         self._render_history_detail(entry)
 
 
     def _on_history_selection_changed(self):
         if not hasattr(self, 'history_table'):
             return
         selection = self.history_table.selectionModel()
         has_selection = bool(selection.selectedRows()) if selection else False
         if hasattr(self, 'history_open_btn'):
             self.history_open_btn.setEnabled(has_selection)
         if hasattr(self, 'history_fua_btn'):
             enable_fua = False
             tooltip = ""
             if has_selection and selection:
                 indexes = selection.selectedRows()
                 if indexes:
                     row = indexes[0].row()
                     history_items = getattr(self, '_history_results', [])
                     if 0 <= row < len(history_items):
@@ -6445,119 +6462,121 @@ class MainWindow(QMainWindow):
                 first_name,
                 patient_last_name,
                 doc_type,
                 doc_value,
                 sex,
                 birth_date,
                 hcl,
                 origin,
                 height,
                 weight,
                 blood_pressure,
                 is_pregnant,
                 gest_age_weeks,
                 expected_delivery,
                 age_years,
                 order_obs,
                 requested_by,
                 insurance_type,
                 fua_number,
                 emitted,
                 emitted_at,
                 sample_status,
                 sample_issue,
                 observation,
                 pending_since,
-                entry_id
+                entry_id,
+                deleted,
+                deleted_reason
             ) = row
             display_date = self._format_date_display(sample_date_str, "-")
             if display_date == "-":
                 display_date = self._format_datetime_display(date_str, date_str or "-")
             patient_name = " ".join(part for part in [(first_name or "").upper(), (patient_last_name or "").upper()] if part).strip() or "-"
             doc_text = " ".join(part for part in (doc_type, doc_value) if part).strip() or "-"
             age_display = str(age_years) if age_years not in (None, "") else "-"
             context = {
                 "patient": {"sex": sex, "birth_date": birth_date},
                 "order": {"age_years": age_years}
             }
             summary_items = self._build_registry_summary(test_name, raw_result, context=context)
             sample_received = self._is_sample_received_status(sample_status)
-            has_result = bool(summary_items)
-            if not summary_items and not sample_received:
-                continue
+            has_result = bool(summary_items) or not self._is_blank_result(raw_result)
             if not summary_items and sample_received:
                 summary_items = [f"{test_name}: Recibida (pendiente resultado)"]
             result_text = "; ".join(summary_items)
             records.append({
                 "entry_id": entry_id,
                 "order_id": order_id,
                 "date": display_date,
                 "order_date_raw": date_str,
                 "sample_date_raw": sample_date_str,
                 "patient": patient_name,
                 "document": doc_text,
                 "doc_type": doc_type,
                 "doc_number": doc_value,
                 "birth_date": birth_date,
                 "hcl": hcl,
                 "height": height,
                 "weight": weight,
                 "blood_pressure": blood_pressure,
                 "sex": sex,
                 "origin": origin,
                 "is_pregnant": is_pregnant,
                 "gestational_age_weeks": gest_age_weeks,
                 "expected_delivery_date": expected_delivery,
                 "age": age_display,
                 "test": test_name,
                 "result": result_text,
                 "summary_items": summary_items,
                 "has_result": has_result,
                 "sample_received": sample_received,
                 "is_critical": self._detect_critical_result(raw_result, summary_items),
                 "category": category,
                 "order_observations": order_obs,
                 "requested_by": requested_by,
                 "insurance_type": insurance_type,
                 "fua_number": fua_number,
                 "emitted": emitted,
                 "emitted_at": emitted_at,
                 "first_name": first_name,
                 "last_name": patient_last_name,
                 "sample_status": sample_status,
                 "sample_issue": sample_issue,
                 "observation": observation,
-                "pending_since": pending_since
+                "pending_since": pending_since,
+                "is_cancelled": bool(deleted),
+                "cancel_reason": deleted_reason
             })
         aggregated = self._aggregate_results_by_order(records)
         self._history_results = aggregated
         self._populate_history_table_widget(self.history_table, aggregated)
         if not aggregated:
             QMessageBox.information(
                 self,
                 "Sin resultados",
-                "No se encontró historial con exámenes realizados o muestras recibidas para los filtros ingresados."
+                "No se encontró historial con exámenes registrados para los filtros ingresados."
             )
             self._render_history_preview(None)
         else:
             self.history_table.selectRow(0)
         self._on_history_selection_changed()
         if hasattr(self, 'history_window_btn'):
             self.history_window_btn.setEnabled(bool(aggregated))
 
     def open_history_window(self):
         aggregated = getattr(self, '_history_results', [])
         if not aggregated:
             QMessageBox.information(self, "Sin resultados", "Primero realice una búsqueda en el historial.")
             return
         dialog = QDialog(self)
         dialog.setWindowTitle("Historial detallado de pacientes")
         layout = QVBoxLayout(dialog)
         filters = []
         if hasattr(self, 'history_doc_input'):
             doc_value = self.history_doc_input.text().strip()
             if doc_value:
                 filters.append(f"DNI: {doc_value}")
         if hasattr(self, 'history_lastname_input'):
             last_value = self.history_lastname_input.text().strip()
             if last_value:
                 filters.append(f"Apellidos: {last_value}")
 
EOF
)